<html>
<head>
  <title>jschess</title>
  <meta charset="utf-8">
  <style>
  table,
  table th,
  table tr,
  table td {
    margin: 0,
    padding: 0,
  }

  table td,
  table th {
    width: 1.3em;
    height: 1.3em;
    text-align: center;
  }

  .board {
    background: #000;
  }

  .square {
    background: #fff;
    font-size: 2.7em;
  }

  .highlight {
    background: red;
  }

  </style>
</head>
<body>

<div id="board">
</div>

<script type="text/javascript" charset="utf-8">
(function () {
  var delimiter = ",",
      files = "abcdefgh",
      ranks = "12345678",
      players = ["white", "black"],
      board = {},
      pieces = {
        "k": "♔", "q": "♕", "r": "♖", "b": "♗", "n": "♘", "p": "♙",
        "K": "♚", "Q": "♛", "R": "♜", "B": "♝", "N": "♞", "P": "♟",
        undefined: " ",
      };

  /* Add a name to elem.className if it's not already present. */
  function addclass(elem, cls) {
    var names = elem.className.split(" ");
    for (var i = 0; i < names.length; i++) {
      if (names[i] == cls) {
        return;
      };
    };
    elem.className += " " + cls;
  };

  /* Initialize board state. */
  function init(board) {
    var initialstate = {
          "8": "RNBQKBNR",
          "7": "PPPPPPPP",
          "2": "pppppppp",
          "1": "rnbqkbnr",
        };

    for (var rank in initialstate) {
      for (var i = 0; i < initialstate[rank].length; i++) {
        board[files[i] + rank] = initialstate[rank][i];
      };
    };
  };

  /* Render a board. */
  function render(board) {
    var table = document.createElement("table");
    addclass(table, "board");

    for (var rank = ranks.length - 1; rank >= 0; rank--) {
      var row = document.createElement("tr"),
          r = ranks[rank];

      for (var file = 0; file < files.length; file++) {
        var f = files[file],
            cell = document.createElement("td"),
            piece = board[f + r];

        addclass(cell, "square");
        cell.id = "position-" + f + r;
        if (piece == undefined) {
          addclass(cell, "empty");
        };
        contents = document.createTextNode(pieces[piece]);
        cell.appendChild(contents);

        row.appendChild(cell);
      };
      table.appendChild(row);
    };

    return table;
  };

  /* Play a game. */
  function play (board, moves) {
    for (var i = 0; i < moves.length; i++) {
      /* XXX: normalize move. */
      var move = moves[i].split(""),
          file = move.pop(),
          rank = move.pop(),
          piece = move.pop(),
          dst = rank + file;

      /* XXX: Handle check. */
      if (piece == undefined) {
        piece = "p";
      }

      /* Choose piece for the player's color. */
      if (i % 2) {
        piece = piece.toUpperCase();
      } else {
        piece = piece.toLowerCase();
      };

      /* XXX: Find srcsquare. */

      var dstsquare = document.getElementById("position-" + dst),
          contents = dstsquare.firstChild;
      dstsquare.replaceChild(
        document.createTextNode(pieces[piece]),
        contents);
    };
  };

  init(board);

  var boardelem = document.getElementById("board"),
      table = render(board);
  boardelem.appendChild(table);

  var moves = window.location.search.substring(1)
    .split("=")[1]
    .split(delimiter);
  play(board, moves);
})();
</script>
</body>
</html>
